tosca_definitions_version: cloudify_dsl_1_3

imports:
  - https://raw.githubusercontent.com/cloudify-cosmo/cloudify-packager/CFY-4881-convert-vagrant-to-blueprint/blueprint/aws-build-blueprint.yaml

inputs:
  plugin_name:
    type: string

dsl_definitions:
  fabric_env: &FAB_ENV
    user: { get_input: ssh_user }
    key_filename: { get_input: ssh_key_filename }
    host_string: { get_attribute: [server_ip, aws_resource_id] }

node_templates:
  build:
    type: build.nodes.Generic
    properties:
      plugin_name: { get_input: plugin_name }
    relationships:
      - type: cloudify.relationships.contained_in
        target: build_host
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          implementation: fabric.fabric_plugin.tasks.run_script
          inputs:
            script_path: scripts/provision.sh
            fabric_env: &FAB_ENV
